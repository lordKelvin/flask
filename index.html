<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Flask Ball Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    box-sizing: border-box;
  }
  #info {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 10px;
    flex-wrap: wrap;
  }
  #game {
    flex: 1;
    width: 100%;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
    gap: 4px;
    padding: 4px;
    box-sizing: border-box;
    max-width: 1000px;
  }
  .flask {
    width: 100%;
    aspect-ratio: 1 / 3;
    border: 2px solid #333;
    border-radius: 10px;
    padding: 2px;
    display: flex;
    flex-direction: column-reverse;
    justify-content: flex-start;
    background: #eee;
    cursor: pointer;
    box-sizing: border-box;
    position: relative;
    max-height: 90vh;
  }
  .ball {
    font-size: 2.4vmin;
    text-align: center;
    margin: 1px 0;
    opacity: 1;
    transform: translateY(0);
    transition: all 0.3s ease;
    position: relative;
  }
  .flask::before {
    content: '';
    position: absolute;
    bottom: 178px;
    left: 0;
    right: 0;
    border-top: 2px dashed #aaa;
    pointer-events: none;
  }
  .flask.selected {
    border-color: red;
  }
  button {
    margin: 6px;
    padding: 6px 12px;
    font-size: 14px;
  }
</style>
</head>
<body>
<h2>Flask Ball Game</h2>
<div id="info">
  <div>Score: <span id="score">0</span></div>
  <div>Wins: <span id="wins">0</span></div>
</div>
<div id="game"></div>
<button onclick="startGame()">Restart Game</button>
<script>
const ballsPerColor = 10;
const colors = ['ðŸ”´','ðŸ”µ','ðŸ”¶','ðŸ”·','ðŸ”¸','ðŸ”¹','ðŸ”º','ðŸ”»'];
const extraFlasks = 2;
const flaskCount = 10;
const flaskSize = 10;
let flasks = [];
let selected = null;
let moveInProgress = false;
let score = parseInt(getCookie('score')) || 0;
let wins = parseInt(getCookie('wins')) || 0;

function updateInfo() {
  document.getElementById('score').textContent = score;
  document.getElementById('wins').textContent = wins;
  document.cookie = `score=${score}`;
  document.cookie = `wins=${wins}`;
}

function createSolvableFlasks() {
  const colorCount = colors.length;
  const filledFlasks = colorCount;
  const balls = [];
  for (let i = 0; i < colorCount; i++) {
    for (let j = 0; j < ballsPerColor; j++) {
      balls.push(colors[i]);
    }
  }
  for (let i = balls.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [balls[i], balls[j]] = [balls[j], balls[i]];
  }
  const flaskArray = Array.from({ length: flaskCount }, () => []);
  let idx = 0;
  while (idx < balls.length) {
    const i = idx % filledFlasks;
    if (flaskArray[i].length < flaskSize) {
      flaskArray[i].push(balls[idx]);
      idx++;
    }
  }
  return flaskArray;
}

function renderGame() {
  const container = document.getElementById('game');
  container.innerHTML = '';
  flasks.forEach((flask, i) => {
    const div = document.createElement('div');
    div.className = 'flask';
    if (i === selected) div.classList.add('selected');
    div.onclick = () => handleClick(i);
    for (let j = 0; j < flaskSize; j++) {
      const ballDiv = document.createElement('div');
      ballDiv.className = 'ball';
      const ball = flask[j];
      ballDiv.textContent = ball ? ball : '';
      div.appendChild(ballDiv);
    }
    container.appendChild(div);
  });
  updateInfo();
}

function handleClick(i) {
  if (moveInProgress) return;
  if (selected === null) {
    if (flasks[i].length === 0) return;
    selected = i;
    renderGame();
  } else {
    if (i !== selected && flasks[selected].length > 0 && flasks[i].length < flaskSize) {
      moveInProgress = true;
      const ball = flasks[selected].pop();
      const targetFlask = document.getElementsByClassName('flask')[i];
      const ghostBall = document.createElement('div');
      ghostBall.className = 'ball';
      ghostBall.textContent = ball;
      ghostBall.style.position = 'absolute';
      ghostBall.style.left = '0';
      ghostBall.style.top = '-40px';
      ghostBall.style.width = '100%';
      targetFlask.appendChild(ghostBall);
      setTimeout(() => {
        ghostBall.style.top = `${(flasks[i].length) * 22}px`;
      }, 10);
      setTimeout(() => {
        targetFlask.removeChild(ghostBall);
        flasks[i].push(ball);
        score++;
        selected = null;
        moveInProgress = false;
        renderGame();
        checkWin();
      }, 310);
    } else {
      selected = null;
      renderGame();
    }
  }
}

function checkWin() {
  const isWin = flasks.every(f => f.length === 0 || (f.length === flaskSize && f.every(b => b === f[0])));
  if (isWin && !moveInProgress) {
    wins++;
    setTimeout(() => {
      startGame();
    }, 100);
  }
}

function startGame() {
  flasks = createSolvableFlasks();
  selected = null;
  moveInProgress = false;
  renderGame();
}

function getCookie(name) {
  const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
  return match ? match[2] : null;
}

startGame();
</script>
</body>
</html>
